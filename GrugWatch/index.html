<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdydWdXYXRjaCIsCiAgInNob3J0X25hbWUiOiAiR3J1Z1dhdGNoIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwYTBhMGEiLAogICJ0aGVtZV9jb2xvciI6ICIjM2I4MmY2Igp9">
    <title>GrugWatch</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: monospace; 
            background: #0a0a0a; 
            color: #e4e4e7; 
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        h1 { margin-bottom: 20px; }
        .counter { font-size: 48px; margin: 20px 0; color: #3b82f6; }
        .info { margin: 10px 0; color: #71717a; font-size: 14px; }
        button { 
            padding: 15px 20px; 
            margin: 5px; 
            border: 1px solid #27272a;
            background: #18181b;
            color: #e4e4e7;
            cursor: pointer;
            font-family: monospace;
            font-size: 14px;
        }
        button:active { background: #27272a; }
        .btn-primary { background: #3b82f6; border-color: #3b82f6; }
        .btn-danger { background: #dc2626; border-color: #dc2626; }
        input { 
            padding: 10px; 
            background: #18181b; 
            border: 1px solid #27272a; 
            color: #e4e4e7;
            font-family: monospace;
            font-size: 14px;
            width: 100%;
            margin: 5px 0;
        }
        .mark { 
            background: #18181b; 
            border: 1px solid #27272a; 
            padding: 15px; 
            margin: 10px 0;
        }
        .mark-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .mark-stats { font-size: 12px; color: #71717a; }
        .mark-stats div { margin: 5px 0; }
        .modal { 
            display: none;
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content { 
            background: #18181b; 
            border: 1px solid #27272a; 
            padding: 30px; 
            max-width: 400px;
            width: 90%;
        }
        .btn-row { display: flex; gap: 10px; margin: 10px 0; }
        .btn-row button { flex: 1; }
        .custom-input-row { display: flex; gap: 5px; margin: 10px 0; }
        .custom-input-row input { flex: 1; }
    </style>
</head>
<body>
    <h1>GRUGWATCH</h1>
    <p class="info">Local Persistence Only</p>
    <button onclick="openEditModal()">EDIT START</button>

    <div class="counter" id="counter">00:00:00</div>
    <div class="info">Elapsed Since Day Start</div>
    <div class="info" id="startInfo">Started: --:--:--</div>

    <div class="btn-row">
        <button onclick="addMark('Coffee')">‚òï Coffee</button>
        <button onclick="addMark('Nap')">üí§ Nap</button>
        <button onclick="addMark('Woke Up')">‚è∞ Woke Up</button>
        <button onclick="addMark('Slept')">üò¥ Slept</button>
    </div>

    <div id="customInput" style="display: none;" class="custom-input-row">
        <input type="text" id="customLabel" placeholder="Label...">
        <button onclick="addCustomMark()">OK</button>
        <button onclick="cancelCustom()">X</button>
    </div>
    <button class="btn-primary" onclick="showCustomInput()" id="markBtn" style="width: 100%; margin: 10px 0;">MARK</button>

    <h2 style="margin-top: 30px;">History</h2>
    <button onclick="handleReset()" id="resetBtn" style="display: none;">Clear All</button>
    <div id="marksList"></div>

    <!-- Edit Start Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Adjust Start Time</h2>
            <p class="info">Change when your "day" began.</p>
            <input type="datetime-local" id="editInput">
            <div class="btn-row">
                <button onclick="closeEditModal()">Cancel</button>
                <button class="btn-primary" onclick="saveStartTime()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'grugwatch_state_v2';
        let state = { startTime: Date.now(), marks: [] };
        let now = Date.now();
        let resetStage = 0;
        let resetTimer = null;

        // Utils
        function formatDuration(ms) {
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function formatRelative(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            if (totalSeconds < 60) return `${totalSeconds}s ago`;
            const minutes = Math.floor(totalSeconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}h ${remainingMinutes}m ago`;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('en-GB', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
        }

        // Persistence
        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    state = JSON.parse(saved);
                } catch (e) {
                    console.error("Failed to parse state", e);
                }
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        // Mark operations
        function addMark(label) {
            const newMark = {
                id: Math.random().toString(36).substring(2, 11),
                label: label.trim() || 'Mark',
                timestamp: Date.now()
            };
            state.marks.unshift(newMark);
            saveState();
            renderFull();
        }

        function deleteMark(id) {
            state.marks = state.marks.filter(m => m.id !== id);
            saveState();
            renderFull();
        }

        function showCustomInput() {
            document.getElementById('customInput').style.display = 'flex';
            document.getElementById('markBtn').style.display = 'none';
            document.getElementById('customLabel').focus();
        }

        function cancelCustom() {
            document.getElementById('customInput').style.display = 'none';
            document.getElementById('markBtn').style.display = 'block';
            document.getElementById('customLabel').value = '';
        }

        function addCustomMark() {
            const label = document.getElementById('customLabel').value;
            addMark(label);
            cancelCustom();
        }

        // Reset
        function handleReset() {
            if (resetStage === 0) {
                resetStage = 1;
                renderFull();
                resetTimer = setTimeout(() => {
                    resetStage = 0;
                    renderFull();
                }, 3000);
            } else {
                state = { startTime: Date.now(), marks: [] };
                resetStage = 0;
                if (resetTimer) clearTimeout(resetTimer);
                saveState();
                renderFull();
            }
        }

        // Edit Start Modal
        function openEditModal() {
            const d = new Date(state.startTime);
            const pad = n => n.toString().padStart(2, '0');
            const value = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            document.getElementById('editInput').value = value;
            document.getElementById('editModal').classList.add('open');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('open');
        }

        function saveStartTime() {
            const value = document.getElementById('editInput').value;
            const timestamp = new Date(value).getTime();
            if (!isNaN(timestamp)) {
                state.startTime = timestamp;
                saveState();
                renderFull();
                closeEditModal();
            }
        }

        // Render only counter (battery friendly - updates frequently)
        function renderCounter() {
            now = Date.now();
            const elapsed = now - state.startTime;
            document.getElementById('counter').textContent = formatDuration(elapsed);
        }

        // Full render (only when state changes)
        function renderFull() {
            now = Date.now();
            const elapsed = now - state.startTime;
            
            document.getElementById('counter').textContent = formatDuration(elapsed);
            document.getElementById('startInfo').textContent = `Started: ${formatTime(state.startTime)}`;

            const resetBtn = document.getElementById('resetBtn');
            if (state.marks.length > 0) {
                resetBtn.style.display = 'inline-block';
                if (resetStage === 1) {
                    resetBtn.textContent = 'Confirm Reset?';
                    resetBtn.className = 'btn-danger';
                } else {
                    resetBtn.textContent = 'Clear All';
                    resetBtn.className = '';
                }
            } else {
                resetBtn.style.display = 'none';
            }

            const marksList = document.getElementById('marksList');
            if (state.marks.length === 0) {
                marksList.innerHTML = '<p class="info">No marks recorded yet.</p>';
            } else {
                marksList.innerHTML = state.marks.map((mark, index) => {
                    const sinceStart = mark.timestamp - state.startTime;
                    const prevMark = state.marks[index + 1];
                    const sinceLast = prevMark ? mark.timestamp - prevMark.timestamp : sinceStart;
                    const relativeToNow = now - mark.timestamp;

                    return `
                        <div class="mark">
                            <div class="mark-header">
                                <div>
                                    <div style="color: #3b82f6; font-size: 10px; margin-bottom: 5px;">${mark.label}</div>
                                    <div style="font-size: 20px;">${formatTime(mark.timestamp)}</div>
                                </div>
                                <button data-mark-id="${mark.id}" class="delete-mark-btn">X</button>
                            </div>
                            <div class="mark-stats">
                                <div>Since Start: ${formatDuration(sinceStart)}</div>
                                <div>Since Prev: ${formatDuration(sinceLast)}</div>
                                <div>Passed: ${formatRelative(relativeToNow)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Attach event listeners to delete buttons
                document.querySelectorAll('.delete-mark-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deleteMark(this.getAttribute('data-mark-id'));
                    });
                });
            }
        }

        // Init
        loadState();
        renderFull();
        setInterval(renderCounter, 1000); // Only update counter every second

        // Keyboard shortcuts
        document.getElementById('customLabel').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addCustomMark();
            if (e.key === 'Escape') cancelCustom();
        });
    </script>
</body>
</html>